# 标题：阴阳师战斗模拟器详细设计


## 文档属性

* 文档格式：Markdown
* 编辑器：MarkdownPad 2 Pro
* 创建时间：2019年3月10日



# 概述

## 背景

半即时回合制RPG手游《阴阳师》在17年推出了定期举行的限时活动“对弈竞猜”。活动中每2小时，游戏向全服玩家公布对战的双方阵容，玩家猜测并下注给胜利一方，猜中则有奖。

截止至2019年3月，网络上（阴阳师nga论坛）也已经有若干个竞猜预测器，主要方法是统计每个式神的历史胜率，再计算新一局的双方胜率，而这种方法普遍不会考虑御魂效果和式神属性。

如果能设计一个程序，对同一阵容的战斗进行多次完整的模拟，得到双方的胜率作为参考，理论上也可以提高成功率。此外，也可以设计自定义阵容，使用程序进行自主试验，或者探究游戏是否真的有“操盘”行为（滑稽）。

然而，这样的模拟有相当大的难度：

* 很多式神都拥有其唯一的特色机制，战斗时会产生更多更复杂的情况。
* 自动战斗中，部分技能的AI机制是不明确的。
* 模拟程序只能近似战斗过程，无法验证其正确性，因为无法像游戏一样让玩家试玩、间接参与测试和修复。

但好在，从2018年中开始，游戏调整并说明了一些游戏机制，比如“间接伤害”，往后更是规范了技能的描述文字，而我在这之前的努力就稍显盲目了。

本人几乎从开服就开始玩（2016年9月中），对游戏的理解有一定的积累。基于面向对象的思想，本文尝试确定对游戏战斗的设计建模（？），模拟战斗的过程。



# 核心设计


## 基础定义


### 效果 {#xiaoguo}

包括被动效果、御魂效果，在特定条件下触发。

### 主动技能 {#zhudongjineng}

自身[回合](#huihe)中可以选择使用的技能。  
按目标选择分类，首先施展技能的对象必须是**己方阵营、敌方阵营、全体阵营**其一，相应阵营存在施展目标时方可施展。继续划分为**指定单个目标、不指定目标**两类。  

### 行动条 {#xingdongtiao}

回合制战斗中式神的行动跑道，每个式神的速度与其在行动条上的移动速度成正比。  
战斗开始时，所有式神在行动条起点（末端）。所有式神同时按各自速度往终点移动，每当一个式神到达终点，此式神获得一个[回合](#huihe)行动机会，所有式神暂停移动，等待式神行动完成后继续进行下一轮的移动。  
式神的行动条可以被**增加**、**击退**、**清空**。

### 回合 {#huihe}

式神到达行动条终点后可获得一次回合行动的机会，未处于[无法行动](#wufaxingdong)的情况下，必须选择使用一个[主动技能](#zhudongjineng)（自动战斗时由AI进行选择）。  
选择使用技能后，回合结束，式神[行动条](#xingdongtiao)回到起点，然后执行技能的[动作](#dongzuo)。  
特殊情况：自身所有[主动技能](#zhudongjineng)都无法施展时，直接结束回合。  

### 行动 {#xingdong}

在特定条件下触发。可以看到式神执行真实的动作，是[动作](#dongzuo)的子集。  
**[反击](#fanji)**也是一次行动。  

### 普通攻击（普攻） {#putonggongji}

[主动技能](#zhudongjineng)的一种，每个式神都有且只有一个普通攻击技能。  



## 主要定义


### 动作 {#dongzuo}

式神的一切操作都抽象为一个动作，一般也是可以在游戏中看到的真实的动作，包括一次攻击、一次施展控制、一次治疗等等。  
典型例子：[赤团华](#chituanhua)  
每次动作结束会进行一定的结算，比如[归鸟](#guiniao)补充飞鸟。  
其他相关：[火鼠裘](#huoshuqiu)

### 触发唯一性 {#chufaweiyixing}

官方描述包括：  

* 单次攻击内最多触发1次。（[木魅](#mumei)）
* 群体攻击、多段攻击不多次触发。（[火鼠裘](#huoshuqiu)）

此类型的效果，在单次[动作](#dongzuo)中只进行1次概率计算。换句话说，此效果的概率是在单次[动作](#dongzuo)中的触发概率，无论攻击有多少段，触发概率保持一致。  

### 主动攻击 {#zhudonggongji}

由以下几种情况引起：

* 执行[主动技能](#zhudongjineng)的行动。
* 进行[协战](#xiezhan)。
* 被[邀战](#yaozhan)。

### 被动攻击 {#beidonggongji}

在特定条件下触发的[行动](#xingdong)所施加的攻击。  
包括[反击](#fanji)。  
不会触发反击。    

### 反击 {#fanji}

特定情况触发的攻击。  

### 不触发效果（御魂、被动） {#buchufaxiaoguo}

部分攻击带有的特性，不触发目标的御魂及被动。但可以触发目标以外的式神的御魂和被动。

### 攻击传递性 {#gongjichuandixing}

攻击带有的特性具有传递性。  
举例说明：反击、不触发效果的攻击，在被涓流、薙魂等分担成为[传导伤害](#chuandaoshanghai)后，依然不触发反击和效果。




## 其他定义


### 幻境唯一性 {#huanjingweiyixing}

幻境存在归属式神，同类型的幻境只能存在一个，施展幻境时会剔除相同幻境。



## 官方通用定义


### 唯一效果 {#weiyixiaoguo}
多个相同式神在场时，只有其中一个的此技能生效。

### 先机 {#xianji}
战斗开始时进行动作。

### 无法行动 {#wufaxingdong}
受到控制效果中的冰冻、沉睡、眩晕、变形时，视为无法行动。

### 协战 {#xiezhan}

特定情况下，友方目标使用[普通攻击](#putonggongji)时，会协战进行攻击。

> 特殊情况：友方被混乱攻击友方时，[姑获鸟](#guhuoniao)会攻击随机敌方。  

### 邀战 {#yaozhan}

被邀战的友方，将使用[普通攻击](#putonggongji)攻击同个敌方目标。

### 混乱 {#hunluan}

被混乱的目标在行动时，强制使用普攻攻击场上随机目标。

> 特殊情况：在混乱状态下，[姑获鸟](#guhuoniao)触发协战、[御馔津](#yuzhuanjin)触发一失·逢魔时，会攻击随机目标。  

### 间接伤害 {#jianjieshanghai}

伤害类型的一种。一般通过附加状态的方式结算，此类状态不受命中抵抗影响，必定命中，并且能够作用于首领单位等目标；未做特别说明时，可以被驱散。具有以下特质：

* 不触发御魂效果(包括攻击方御魂和受击方御魂)
* 不被其他能力或效果分摊(如涓流、薙魂、金鱼助阵等)
* 受攻击者的暴击暴伤、受击者的防御力等属性影响，若受击目标的防御力为0，则必定暴击
* 所有单位的防御力最低被降至0点。

> 补充说明：间接伤害视为[被动攻击](#beidonggongji)。  

### 中毒 {#zhongdu}

中毒是一种常规的减益状态，可以被驱散，受命中抵抗影响，共有9个等级，效果为降低目标10%速度，同时在结算间接伤害时忽略目标“中毒状态等级*10点”防御力，各等级中毒状态的忽略防御效果可以无限制相互叠加，但减速效果唯一。

### 单体伤害 {#dantishanghai}

* 现在对于单体伤害以及群体伤害的判定，不再像之前以技能施放时是否指定目标来判定，而是以造成伤害时的实际情况来判定。主要的判定标准按照直观效果以及配合技能叙述来实行。同时，间接伤害将不再被视为单体伤害。
* 技能叙述中，使用以下文字叙述的为单体伤害，如:“敌方目标”、“每个敌方”、“随机敌方”、“任一敌方”。
* 使用以下文字叙述的为群体伤害:“敌方全体”、“其他敌方”。

### 传导伤害 {#chuandaoshanghai}

伤害类型的一种，不会暴击，不触发薙魂。由某些技能转化出现，如涓流和草人替身。



## 式神技能与相关定义（满级）


### 省略说明

* 造成伤害时的百分比，默认是攻击的百分比。
* 治疗的百分比，默认是自身生命的百分比。
* 命中、抵抗代指效果命中、效果抵抗


### 辉夜姬 {#huiyeji}

#### 火鼠裘 {#huoshuqiu}  

[唯一效果](#weiyixiaoguo)。  
受到攻击时，40%获得1点鬼火。  
若有[**龙首之玉**](#longshouzhiyu)幻境，任一友方受到攻击也会触发。群体攻击、多段攻击不多次触发。  
[先机](#xianji)：释放[**龙首之玉**](#longshouzhiyu)  

#### 龙首之玉 {#longshouzhiyu}  

创造存在2回合的幻境，友方全体提升25%防御、20%抵抗，在回合开始前有67%概率获得1点鬼火。  


### 彼岸花 {#bianhua}

#### 赤团华 {#chituanhua}

[唯一效果](#weiyixiaoguo)。  
敌方回合开始时，每层花海造成39%伤害。  
自身生命比例100%、75%、50%、25%时，花海上限为3、4、5、6层；回合开始时减少1层，最少1层。  
生命比例每降低25%，获得1层花海及血之花海护盾。  
[先机](#xianji)：获得3层花海。  


### 花鸟卷 {#huaniaojuan}

#### 归鸟 {#guiniao}

攻击敌方目标，飞鸟数量决定次数，每次40%，50%为生命比例最低的友方治疗10%。  
回合开始或没有飞鸟时，补充1只飞鸟，上限3只。  
[反击](#fanji)时消耗1只飞鸟。  


### 姑获鸟 {#guhuoniao}

### 御馔津 {#yuzhuanjin}



## 御魂定义


### 木魅 {#mumei}

友方受到伤害时，25%削减伤害者1点鬼火，单次攻击内最多触发1次；对被嘲讽目标降低60%触发概率。



## 规则定义


### 特殊机制规则






## 待整合的特殊机制


### 化鲸

### 青蛙瓷器死亡状态

应该不能被攻击。



